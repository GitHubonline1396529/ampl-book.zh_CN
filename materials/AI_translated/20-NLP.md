# 非线性规划

虽然任何违反第 8 章线性规则的模型都“不是线性的”，但传统上“非线性规划 (nonlinear program)”这一术语的使用范围更为狭窄。在本章中，非线性规划与线性规划类似，具有连续 (而非整数或离散) 变量；其目标函数和约束中的表达式不必是线性的，但必须表示“光滑 (smooth)”函数。直观上，一个单变量的光滑函数的图像如图 18-1a 所示，在每一点上都有明确定义的斜率；不像图 18-1b 中那样存在跳跃，或像图 18-1c 中那样存在折点。从数学上讲，任何数量变量的光滑函数必须是连续的，并且在每一点上都必须有明确定义的梯度 (一阶导数组成的向量)；图 18-1b 和 18-1c 分别展示了函数不连续和不可微的点。

这类函数的优化问题之所以被特别关注，有几个原因：它们容易与其他“非线性”问题区分开来；它们具有广泛而多样的应用；并且它们可以通过一些成熟的算法类型来求解。实际上，大多数非线性规划求解器都使用依赖于连续性和可微性假设的方法。即使有这些假设，非线性规划通常也比类似的线性规划更难建立和求解。

本章首先介绍数学规划中非线性的来源。我们并不试图系统地涵盖各种非线性模型，而是给出一些示例，说明非线性出现的原因和方式。接下来的部分将讨论非线性对 AMPL 变量和表达式的影响。最后，我们将指出在尝试求解非线性规划时可能遇到的一些困难。

尽管本章的重点是非线性优化，请注意 AMPL 也可以表示非线性方程组或不等式组，即使没有需要优化的目标函数。存在专门用于这种情况的求解器，许多用于非线性优化的求解器也能较好地找到方程组或不等式组的可行解。

![](https://cdn-mineru.openxlab.org.cn/result/2025-09-04/c27db974-6ee8-418f-9d81-3e975c6552ef/e0f04df39837466c8484b2ffe549de4583a50620e99b05e90b6d77124ebd60a7.jpg)  
图 18-1：非线性函数的类别。

(a) 光滑且连续的函数

(b) 不连续的函数

(c) 连续但不可微的函数

# 18.1 非线性的来源

我们在此讨论在优化模型中引入非线性的三种方式：通过放弃线性假设、通过构建非线性函数以达到预期效果，以及通过建模本身具有非线性的物理过程。

作为示例，我们描述一些线性网络流模型 net1.mod 的非线性变体，该模型在第 15 章中引入（见图 15-2a）。该线性规划的目标是最小化总运输成本，即最小化总成本：

$$
\text{minimize Total Cost: } \sum_{(i,j) \in \text{LINKS}} \text{cost}[i,j] \times \text{Ship}[i,j];
$$

其中，$\text{cost}[i,j]$ 和 $\text{Ship}[i,j]$ 分别表示城市 $i$ 与城市 $j$ 之间每单位的运输成本和总运输量，$\text{LINKS}$ 表示所有存在运输路线的城市对集合。约束条件是每个城市的流量平衡：

$$
\text{约束条件 平衡 } \{k \in \text{CITIES}\}: \text{supply}[k] + \sum_{(i,k) \in \text{LINKS}} \text{Ship}[i,k] = \text{demand}[k] + \sum_{(k,j) \in \text{LINKS}} \text{Ship}[k,j];
$$

其中非负参数 $\text{supply}[i]$ 和 $\text{demand}[i]$ 分别表示城市 $i$ 的可用或所需单位数量。

# 放弃线性假设

线性网络流模型假设从城市 $i$ 到城市 $j$ 运输的每一单位货物都产生相同的运输成本 $\text{cost}[i,j]$。图 18-2a 展示了这种情况下运输成本与运输量之间的典型关系图；该图为一条斜率为 $\text{cost}[i,j]$ 的直线（因此称为线性）。图 18-2 中的其他图则展示了运输成本可能依赖于运输量的多种非线性方式。

在图 18-2b 中，成本也倾向于随运输量线性增长，但在某些关键运输量处，单位成本（即直线的斜率）会发生突变。这种函数称为分段线性（piecewise linear）。严格来说，它不是线性的，但也不是平滑的非线性函数。分段线性目标函数的使用是第 17 章的主题。

在图 18-2c 中，函数本身会发生突变。当没有运输时，运输成本为零；但一旦有任何运输量，成本从一个大于零的值开始呈线性增长。在这种情况下，从 $i$ 到 $j$ 的链路存在一个固定成本，再加上每单位运输量的可变成本。同样，这不是线性规划技术可以处理的函数，但它也不是平滑的非线性函数。固定成本通常通过使用整数变量来处理，这将在第 20 章中讨论。

其余的图展示了本章中我们希望考虑的平滑非线性函数类型。图 18-2d 展示了一种凹成本函数。每增加一单位运输量的增量成本（即图形的斜率）最初较大，但随着运输量的增加而减小；在某一点之后，成本几乎呈线性增长。这是对图 18-2c 中固定成本函数的一种连续替代方式。它也可以用来近似图 18-2b 中的情形，即随着运输量的增加，可获得批量折扣的情况。

图 18-2e 显示了一种凸成本函数。对于较小的运输量，成本大致呈线性增长，但当运输量接近某个临界值时，成本会急剧上升。这种函数用于建模这样一种情况：即首先使用成本最低的运输方式，随着运输单位数量的增加，运输成本逐渐升高。这个临界值实际上代表了运输量的一个上限。

这些是最简单的函数形式。你所选用的函数将取决于你要建模的具体情况。图 18-2f 显示了一种既非凹也非凸的函数形式，它结合了前两个例子的特征。

线性函数除了系数 (或斜率) 不同之外，本质上都是一样的；而非线性函数可以由无穷多种不同的公式来定义。因此，在构建非线性规划模型时，你需要自行推导或指定能够准确表示当前情况的非线性函数。在运输问题示例的目标函数中，例如，一种可能的做法是将原来的乘积项 `cost[i,j] * Ship[i,j]` 替换为：

\[
\frac{cost1[i,j] + cost2[i,j] \cdot Ship[i,j]}{1 + Ship[i,j]} \cdot Ship[i,j]
\]

该函数在运输量较小时迅速增长，而在运输量较大时趋于平缓，基本上呈线性关系。因此，它体现了一种实现图 18-2d 所示曲线的方法。

另一种指定非线性目标函数的方法是关注图 18-2 中各图的斜率。在线性情形 (图 18-2a) 中，图线的斜率恒定；这就是为什么我们可以使用单一参数 `cost[i,j]` 来表示单位运输成本。在分段线性情形 (图 18-2b) 中，每个区间内的斜率是恒定的；我们可以通过第 17 章中介绍的方法来表达这类分段线性函数。

然而，在非线性情形下，斜率随着运输量的变化而连续变化。这提示我们可以回到最初网络流问题的线性形式，并将参数 `cost[i,j]` 转换为变量 `Cost[i,j]`：

```ampl
var Cost {ORIG, DEST}; # 每单位运输成本变量  
var Ship {ORIG, DEST} >= 0; # 运输量  
minimize Total_Cost: sum {i in ORIG, j in DEST} Cost[i,j] * Ship[i,j];
```

这不再是一个线性目标函数，因为它包含了变量与变量之间的乘积。我们再添加一些方程以说明成本与运输量之间的关系：

```ampl
subject to Cost_Relation {i in ORIG, j in DEST}:  
Cost[i,j] = (cost1[i,j] + cost2[i,j]*Ship[i,j]) / (1 + Ship[i,j]);
```

这些方程也是非线性的，因为它们涉及除以一个包含变量的表达式。很容易看出，当运输量接近零时，`Cost[i,j]` 接近 `cost1[i,j]`，但当运输水平足够高时，会趋于 `cost2[i,j]`。因此，只要第一个成本大于第二个成本，就能实现图 18-2d 中的凹成本 (concave cost)。

非线性的假设也可以出现在约束中。网络流模型的约束只体现了弱线性假设，即从一个城市运出的总量是运往其他各城市的运输量之和。但在图 1-6a 的生产模型中，约束体现了一个强假设：制造每种产品 `p` 在每个阶段 `s` 所使用的小时数随着生产水平线性增长。

# 实现非线性效果

有时非线性来源于需要建模一种线性函数根本无法表现出期望行为的情况。

例如，在交通流的网络模型中，可能有必要考虑拥堵因素。对于小的运输量，穿越运输链接的总时间应基本上为常数，但当接近链接容量时，应迅速增加至无穷大。没有线性函数具备这种性质，因此我们被迫使旅行时间成为运输负载的非线性函数，以获得期望的效果。

表示旅行时间的一种可能函数如下：

$$
\mathtt{time}[\mathtt{i},\mathtt{j}] + (\mathtt{sens}[\mathtt{i},\mathtt{j}]\star \mathtt{ship}[\mathtt{i},\mathtt{j}]) / (1 - \mathtt{ship}[\mathtt{i},\mathtt{j}] / \mathtt{cap}[\mathtt{i},\mathtt{j}])
$$

当 Ship[i,j] 的值较小时，该函数近似为 time[i,j]，但当 Ship[i,j] 接近 cap[i,j] 时趋向无穷大；第三个参数 sens[i,j] 控制着函数在两个极端之间的形状。该函数始终是凸的，因此其图形类似于图 18-2e。（练习 18-4 建议了如何将该旅行时间函数整合到交通流的网络模型中。）

另一个例子是，我们可能希望允许需求只能被近似满足。我们可以通过引入一个变量 Discrepancy[k] 来建模这种可能性，用以表示交付量与需求量之间的偏差。这个变量可以为正也可以为负，它被加到平衡约束的右侧：

subject to Balance {k in CITIES}: supply[k] $+$ sum {i,k) in LINKS} Ship[i,k] $=$ demand[k] $+$ Discrepancy[k] $+$ sum {k,j) in LINKS} Ship[k,j];

一种已确立的方法是通过在目标函数中添加惩罚成本来防止偏差变得过大。如果该惩罚与偏差量成正比，则我们得到一个凸分段线性惩罚项，

最小化 总成本 (Total Cost)：$\sum_{(i,j) \in LINKS} cost[i,j] \times Ship[i,j] + \sum_{k \in CITIES} pen \times Discrepancy[k]$；

其中 pen 是一个正参数。AMPL 可以轻松地将此目标函数转换为线性形式。

然而，这种形式的惩罚项可能无法达到我们想要的效果，因为它对差异 (discrepancy) 的每一单位都施加了相同的惩罚。为了抑制较大的差异，我们希望随着差异的加剧，每单位的惩罚逐渐增大，但这一特性无法通过线性惩罚函数（或具有有限段的分段线性函数）实现。取而代之的是，一个更合适的惩罚函数应为二次函数：

最小化 总成本 (Total_Cost)：$\sum_{(i,j) \in LINKS} cost[i,j] \times Ship[i,j] + \sum_{k \in CITIES} pen \times Discrepancy[k]^2$；

在涉及逼近或数据拟合的优化问题中，目标函数为某些量的平方和的非线性目标非常常见。

# 对本质上非线性过程的建模

在诸如石油精炼 (N)、电力传输和结构设计等物理活动的模型中，存在许多非线性来源。大多数情况下，这些模型中的非线性并非源于对线性假设的放松，而是由支配力、体积、电流等的固有非线性关系所导致。物理模型中非线性函数的形式可能更容易确定，因为它们来源于经验测量和物理基本定律（而非经济因素）。另一方面，物理模型中的非线性往往涉及更复杂的函数形式以及变量之间的相互作用。

举一个简单的例子，在天然气管道网络的模型中，不仅要考虑城市之间的运输量 (shipments)，还要考虑各个城市的压力，且压力受到某些界限的约束。因此，除了流量变量 Ship[i, j] 外，模型还必须定义一个变量 Press[k] 来表示每个城市 k 的压力。如果城市 i 的压力大于城市 j，则流量从 i 流向 j，并满足以下关系：

$$
\mathtt{Flow}[\mathtt{i},\mathtt{j}]^2 = \mathtt{c}[\mathtt{i},\mathtt{j}]^2 \times (\mathtt{Press}[\mathtt{i}]^2 - \mathtt{Press}[\mathtt{j}]^2)
$$

其中 $\mathtt{c}[\mathtt{i},\mathtt{j}]$ 是由管道的长度、直径和效率以及气体性质决定的常数。管道上的压缩机和阀门会产生不同的非线性流量关系。其他类型的网络，特别是电力传输网络，也有其特定的非线性流量关系，这些关系由物理规律决定。

如果你知道想要包含在模型中的非线性表达式的代数形式，那么你很可能已经能看出如何在 AMPL 中编写它。本章接下来的两节将分别考虑与为非线性规划声明变量以及编写非线性表达式相关的一些具体问题和特性。然而，为了避免你因编写非线性表达式过于简单而忽视潜在问题，最后一节将就求解非线性规划给出一些警示性建议。

# 18.2 非线性变量

尽管 AMPL 中为非线性规划声明变量的方式与线性规划相同，但变量的两个特性——初值 (initial values) 和自动替代 (automatic substitution) 在处理非线性模型时特别有用。

# 变量的初值

你可以为 AMPL 变量指定值。在优化之前，这些“初始”值可以通过 AMPL 命令进行显示和操作。当你输入 solve 命令时，这些初始值会被传递给求解器，求解器可能会将它们作为解的初始猜测值。在求解器完成工作后，这些初始值将被计算出的最优值所取代。

所有用于为参数赋值的 AMPL 特性同样也适用于变量。在 var 声明中还可以通过可选的 $\coloneqq$ 短语来指定初始值；对于运输问题的例子，你可以写成

$$
\mathtt{var}\ \mathtt{Ship}\{\mathtt{LINKS}\} >= 0,\ \mathtt{\coloneqq}\ 1;
$$

将每个 Ship[i,j] 的初始值设为 1，或者写成

$$
\mathtt{var}\ \mathtt{Ship}\{(\mathtt{i,j})\ \mathtt{in}\ \mathtt{LINKS}\} >= 0,\ \mathtt{\coloneqq}\ \mathtt{cap}[\mathtt{i,j}] - 1;
$$

将每个 Ship[i,j] 初始化为 cap[i,j] 减 1。或者，也可以在数据语句中与模型的其他数据一起给出初始值：

<table><tr><td>var Ship:</td><td>FRA</td><td>DET</td><td>LAN</td><td>WIN</td><td>STL</td><td>FRE</td><td>LAF</td><td>:=</td></tr><tr><td>GARY</td><td>800</td><td>400</td><td>400</td><td>200</td><td>400</td><td>200</td><td>200</td><td></td></tr><tr><td>CLEV</td><td>800</td><td>800</td><td>800</td><td>600</td><td>600</td><td>500</td><td>600</td><td></td></tr><tr><td>PITT</td><td>800</td><td>800</td><td>800</td><td>200</td><td>300</td><td>800</td><td>500</td><td>,</td></tr></table>

所有用于参数的数据语句同样也可以用于变量，如第 9.4 节所述。

所有这些为常规（“原始”）变量赋值的特性同样也适用于与约束相关联的对偶变量（第 12.5 节）。AMPL 将对约束名称的赋值解释为对相关联的对偶变量或（在非线性规划中更常见的术语）相关联的拉格朗日乘数 (Lagrange multiplier) 的赋值。少数求解器，例如 MINOS，可以利用这些乘数的初始值。

通过为变量提供良好的初始值，通常可以加快求解器的工作速度。即使对于线性规划问题也是如此，但在非线性情况下效果更为显著。初始猜测值的选择可能会决定求解器找到的“最优”目标函数值，甚至可能影响求解器是否能找到任何最优解。这些可能性在本章最后一节中将进一步讨论。

如果你没有为某个变量指定初始值，那么 AMPL 会暂时将其设为零。如果求解器内置了确定初始值的程序，那么它可能会重新设置未初始化变量的值，同时利用已初始化变量的值。否则，未初始化的变量将保持为零。虽然零是一个显而易见的起点，但它并没有特殊的意义；在第 18.4 节中我们将给出的一些例子中，除非将初始值从零重新设定，否则求解器无法成功进行优化。

# 变量的自动替换

在上一节的一个例子中已经出现了变量替换的问题，我们在其中声明了变量来表示运输成本，然后通过一个约束条件用其他变量来定义它们：

subject to Cost_Relation {(i,j) in LINKS}: Cost[i,j] = (cost1[i,j] + cost2[i,j]*Ship[i,j]) / (1 + Ship[i,j]);

如果将等号右侧的表达式替换所有出现的 Cost[i,j]，就可以从模型中消除 Cost 变量，并且这些约束无需传递给求解器。有两种方法可以告诉 AMPL 自动进行此类替换。

第一种方法是将选项 `substout` 从默认值 `0` 改为 `1`，这样可以告诉 AMPL 寻找所有具有上述形式的“定义”约束：等号左侧为单个变量。采用这种替代方式时，AMPL 会尝试使用尽可能多的这类约束，将变量从模型中替换出去。当你输入 `solve` 命令后，模型和数据生成了一个非线性规划 (nonlinear program) 问题时，约束将按照它们在模型中出现的顺序进行扫描。一个约束被识别为“定义”约束的条件是：它在等号左侧只有一个变量；该左侧变量的声明未指定任何限制（如整数性或边界）；并且该左侧变量尚未出现在已被识别为定义约束的其他约束中。

然后，等号右侧的表达式将替换其他约束中出现的左侧变量，定义约束本身将被删除。这些规则为 AMPL 提供了一种简单的方法来避免循环替换，但这也意味着替换的性质和数量可能依赖于约束的排序。

作为替代，如果您想明确指定要代换出某个特定的变量集合，请在变量声明中使用 `=` 短语。对于前面的例子，您可以写成：

```ampl
var Cost {(i,j) in LINKS} = (cost1[i,j] + cost2[i,j]*Ship[i,j]) / (1 + Ship[i,j]);
```

然后变量 `Cost[i,j]` 将会被 `=` 符号后面的表达式所替代。这种类型的声明可以以任意顺序出现，但需满足通常的要求，即在 `=` 短语中出现的每个变量都必须事先定义。

可以代换出去的变量在优化问题中并不是数学上必需的。尽管如此，它们往往具有重要的描述性作用；通过为非线性表达式关联名称，它们使得更复杂的表达式能够被清晰地书写。此外，即使这些变量已从传递给求解器 (solver) 的问题中移除，它们的名称仍可用于浏览优化结果。

当同一个非线性表达式在目标函数和约束中多次出现时，引入一个定义变量来表示它可以使模型更加简洁且更具可读性。AMPL 也能高效地处理这种代换。在为求解器生成非线性规划 (nonlinear program) 的表示形式时，AMPL 并不会将整个定义表达式的副本替换到定义变量的每个出现位置。相反，它将表达式分解为线性和非线性部分，并保存一份非线性部分的副本以及其值应被替换的位置列表；只有线性部分的项会在多个位置被显式替换。这种对线性项的单独处理对某些求解器（如 MINOS）是有利的，因为它们会特殊处理线性项，但您可以通过将选项 `linelim` 设置为零来关闭这一功能。

从求解器的角度来看，代换会减少约束和变量的数量，但往往会使约束和目标表达式更加复杂。因此，在某些情况下，如果不代换定义变量，求解器的表现可能会更好。在开发新模型时，您可能需要通过实验来确定哪些代换能够带来最佳结果。

# 18.3 非线性表达式

AMPL 的任何算术运算符 （表 7-1） 和算术函数 （表 7-2） 都可以应用于 变量 （variable） 以及 参数 （parameter） 。 如果由此产生的任何 目标 （objective） 或 约束 （constraint） 不满足 线性 （第 8 章） 或 分段线性 （第 17 章） 的规则， AMPL 会将其视为 “非线性” 。 当您键入 solve 时， AMPL 会传递足够的指令， 使您的 求解器 （solver） 能够计算每个 目标 和 约束 中的每个 表达式 （expression） ， 并在适当时提供导数。

如果你使用的是典型的非线性 求解器 ， 那么你需要自己将 目标函数 （objective function） 和 约束 定义为该 求解器 所要求的 “光滑” 函数。 在这方面， AMPL 的 表达式 （expression） 语法的通用性可能会产生误导。 例如， 如果你试图使用 变量 Flow[i,j] 来表示点 i 和 j 之间的流量， 那么你可能会写出像 cost[i,j] * abs(Flow[i,j]) 或 if Flow[i,j] $= 0$ then 0 else base[i,j] $^+$ cost[i,j]*Flow[i,j] 这样的 表达式 。

这些 表达式 显然不是线性的， 但第一个 表达式 不是光滑的 （其斜率在零点处突然改变） ， 第二个 表达式 甚至不是连续的 （其值在零点处突然跳跃） 。 如果你尝试使用这样的 表达式 ， AMPL 不会报错， 你的 求解器 甚至可能返回它声称是 最优解 的结果——但结果可能是错误的。

将非光滑函数 （如 abs、 min 和 max） 应用于 变量 的 表达式 通常会产生非光滑的结果； 同样， 如果 if-then-else 表达式 中 if 后面的 条件 （condition） 包含 变量 ， 那么该 表达式 通常也不是光滑的。 尽管如此， 在某些情况下， 通过精心编写的 表达式 可以保持光滑性。 例如， 再次考虑第 18.1 节中的流量-压力关系。 如果城市 i 的压力大于城市 j 的压力， 那么流量方向是从 i 到 j， 并且流量与压力的关系为：

$$
\mathtt{Flow}[\mathtt{i},\mathtt{j}]^{\wedge}2 = \mathtt{c}[\mathtt{i},\mathtt{j}]^{\wedge}2\ast (\mathtt{Press}[\mathtt{i}]^{\wedge}2 - \mathtt{Press}[\mathtt{j}]^{\wedge}2)
$$

如果城市 j 的压力大于城市 i 的压力， 则可以写出类似的方程：

$$
\mathtt{Flow}[\mathtt{j},\mathtt{i}]^{\wedge}2 = \mathtt{c}[\mathtt{j},\mathtt{i}]^{\wedge}2\ast (\mathtt{Press}[\mathtt{j}]^{\wedge}2 - \mathtt{Press}[\mathtt{i}]^{\wedge}2)
$$

但由于常数 $\mathbb{C}[\mathbf{i},\mathbf{j}]$ 和 $\mathbb{C}[\mathbf{j},\mathbf{i}]$ 指的是同一条管道， 因此它们是相等的。 因此， 我们不需要为每个方向的流量定义单独的 变量 ， 而是可以让 $\mathtt{Flow}[\mathtt{i},\mathtt{j}]$ 的符号不受限制， 正值表示从 i 到 j 的流量， 负值表示相反方向的流量。 使用这个 变量 ， 前面的一对流量-压力 约束 可以被替换为一个：

$$
\begin{array}{rl}
& (\texttt{if}\ \mathtt{Flow}[\mathtt{i},\mathtt{j}] >= 0\ \mathtt{then}\ \mathtt{Flow}[\mathtt{i},\mathtt{j}]^{\wedge}2\ \mathtt{else}\ -\mathtt{Flow}[\mathtt{i},\mathtt{j}]^{\wedge}2) \\
& \qquad = \mathtt{c}[\mathtt{i},\mathtt{j}]^{\wedge}2 \ast (\mathtt{Press}[\mathtt{i}]^{\wedge}2 - \mathtt{Press}[\mathtt{j}]^{\wedge}2)
\end{array}
$$

通常，使用 if 表达式会产生非光滑 (nonsmooth) 约束，但在这种情况下，它产生了一个函数，其两个二次部分在 $\mathtt{Flow}[\mathtt{i},\mathtt{j}]$ 为零时“光滑相接”，如图 18-3a 所示。

另一个例子是图 18-3b 中的凸函数，最简单的写法是 $\log (\mathtt{Flow}[\mathtt{i},\mathtt{j}]) / (\mathtt{Flow}[\mathtt{i},\mathtt{j}] - 1)$，但不幸的是，如果 $\mathtt{Flow}[\mathtt{i},\mathtt{j}]$ 为 1，则该表达式简化为 $0 / 0$，这会被报告为错误。实际上，即使 $\mathtt{Flow}[\mathtt{i},\mathtt{j}]$ 只是非常接近 1，该表达式也无法准确计算。如果我们改写为

if abs(Flow[i,j]- 1) > 0.00001 then log(Flow[i,j] / (Flow[i,j]- 1) else 1.5 - Flow[i,j]/2

则在 Flow[i,j] 的量级较小时，会代之以一个高度精确的线性近似。这种替代方式在严格的数学意义上并非光滑函数，但在数值上足够接近光滑，足以用于某些 求解器。

在发送给 求解器 的问题实例中，AMPL 会区分线性与非线性约束和目标函数，并将每个约束和目标表达式分解为线性项之和加上一个非线性部分。由于某些变量被固定而变成线性的附加项也会被识别为线性项。例如，在我们 18.1 节的例子中，

minimize Total Cost: sum {i in ORIG, j in DEST} Cost[i,j] * Ship[i,j];

每次固定一个 Cost[i,j] 变量都会产生一个线性项；如果所有 Cost[i,j] 变量都被固定，则目标函数会被表示为线性函数提供给 求解器。变量可以通过 fix 命令（第 11.4 节）或通过 presolve 阶段的操作（第 14.1 节）来固定；尽管预求解算法会忽略非线性约束，但它会处理所有可用的线性约束，以及随着变量固定而变为线性的约束。

AMPL 的内置函数只是模型构建中最常用的一些函数。在需要时可以引入其他有用的函数库。例如，要使用名为 statlib 的函数库中的累积正态分布函数和反累积正态分布函数，首先需要用如下语句加载该库：

load statlib.dll;

并通过 AMPL 的 function 语句声明这些函数：

function cumnormal; function invcumnormal;

然后模型就可以使用这些函数来构成表达式，例如 cumnormal(mean[i], sdev[i], Inv[i,t]) 和 invcumnormal(6)。如果这些函数作用于变量，AMPL 还会安排在求解过程中执行函数求值。

函数声明指定了库函数的名称及其 (可选的) 必需参数。参数的数量可以是任意多个，甚至可以是迭代的参数集合。每个函数的声明必须出现在其使用之前。为了方便起见，可以随库一起提供包含函数声明的脚本，因此像 `include statlib` 这样的语句就足以提供对库中所有函数的访问权限。库的文档将说明可用的函数及其参数的数量和含义。

确定正确的加载命令可能涉及许多细节，这些细节取决于你所使用的系统类型甚至其特定配置。有关可能性及相关 `AMPLFUNC` 选项的进一步讨论，请参见第 A.22 节。

如果你有雄心，可以编写并编译自己的函数库。相关说明和示例可从 AMPL 网站获取。

# 18.4 非线性规划的陷阱

虽然 AMPL 使你能够构建各种非线性优化模型，但当你输入 `solve` 时，并没有任何求解器能保证每次都得到可接受的解。求解器所使用的算法容易受到非线性函数复杂性所带来的各种困难的影响。这与线性情况形成了令人遗憾的对比，在线性情况下，一个设计良好的求解器几乎可以可靠地求解任何线性规划。

本节简要介绍非线性规划的陷阱。我们重点关注两类常见困难：函数值域违规和多个局部最优解，然后简要提及其他几种陷阱。

为了说明问题，我们从图 18-4 所示的非线性运输模型开始。它与我们之前的运输示例 (图 3-1a) 相同，只是目标函数中的项 `cost[i,j] * Trans[i,j]` 被替换为非线性项：

```
minimize Total Cost:
  sum {i in ORIG, j in DEST}
    rate[i,j] * Trans[i,j] / (1 - Trans[i,j]/limit[i,j]);
```

每项都是 `Trans[i,j]` 的凸递增函数，如图 18-2e 所示；在 `Trans[i,j]` 相对较小的值时，它近似于斜率为 `rate[i,j]` 的线性函数，但当 `Trans[i,j]` 接近 `limit[i,j]` 时趋于无穷大。相关数据值也类似于第 3 章中线性运输示例所使用的数据，见图 18-5。

# 函数值域违规

尝试使用给定的模型和数据进行求解时失败了：

```
ampl: model nltrans.mod;
ampl: data nltrans.dat;
ampl: solve;
MINOS 5.5 Error evaluating objective Total_Cost
can't compute 8000/0
MINOS 5.5: solution aborted.
8 iterations, objective 0
```

求解器的消息令人费解，但强烈暗示在计算目标函数时发生了除以零的情况。这只有在表达式

```
1 - Trans[i,j]/limit[i,j]
```

等于零时才会发生。

```
param supply {ORIG} >= 0;    # 起始地的可用量
param demand {DEST} >= 0;    # 目的地的需求量
check: sum {i in ORIG} supply[i] = sum {j in DEST} demand[j];

param rate {ORIG,DEST} >= 0; # 每单位的基础运输成本
param limit {ORIG,DEST} > 0; # 运输单位的限制

var Trans {i in ORIG, j in DEST} >= 0;  # 待运输的单位数

minimize Total Cost:
  sum {i in ORIG, j in DEST}
    rate[i,j] * Trans[i,j] / (1 - Trans[i,j]/limit[i,j]);
```

$$\sum_{i \in ORIG, j \in DEST} \frac{rate[i,j] \cdot Trans[i,j]}{1 - \frac{Trans[i,j]}{limit[i,j]}}$$

约束条件  
供应量  
$$\sum_{j \in DEST} Trans[i,j] = supply[i], \quad \forall i \in ORIG$$

需求量  
$$\sum_{i \in ORIG} Trans[i,j] = demand[j], \quad \forall j \in DEST$$

图 18-4: 非线性运输模型 (nltrans.mod)。

![](https://cdn-mineru.openxlab.org.cn/result/2025-09-04/c27db974-6ee8-418f-9d81-3e975c6552ef/95e49b4d1777325531b114cd5d87f9eab92e9cdf0b15f2dd9ee435f8bdef05db.jpg)  
图 18-5: 非线性运输模型的数据 (nltrans.dat)。

在某点为零。如果我们使用 display 来打印 Trans[i, j] 等于 limit[i, j] 的对：

impl: display {i in ORIG, j in DEST: Trans[i,j] = limit[i,j]};  
set {i in ORIG, j in DEST: Trans[i,j] == limit[i,j]} := (GARY, LAF) (PITT, LAN);

impl: display Trans['GARY','LAF'], limit['GARY','LAF'];  
Trans['GARY','LAF'] = 1000  
limit['GARY','LAF'] = 1000

我们可以看到问题所在。求解器允许 Trans[GARY, LAF] 的值为 1000，这等于 limit[GARY, LAF]。结果，目标函数项 rate[GARY, LAF] * Trans[GARY, LAF] / (1 - Trans[GARY, LAF]/limit[GARY, LAF]) 的计算结果为 $8000 / 0$。由于求解器无法评估目标函数，它放弃了寻找最优解。

因为非线性优化算法的行为可能对初始猜测的选择敏感，我们可能希望求解器从不同的起点取得更大的成功。为了确保比较有意义，我们首先设置

ampl: option send_statuses 0;

这样，上一次求解返回的变量状态信息将不会被发送回去，以帮助确定下一次求解的起点。然后可以使用 AMPL 的 let 命令建议，例如，每个 Trans[i, j] 的新初始值为 limit[i, j] 的一半：

ampl: let {i in ORIG, j in DEST} Trans[i, j] := limit[i, j]/2;  
ampl: solve;  
MINDS 5.5: 当前点无法改进。  
32 次迭代，目标值 - 7.385903389e+18

这次求解器运行完成，但仍然存在问题。目标值小于 $- 10^{18}$，或者在实际应用中为 $- \infty$，并且解被描述为“无法改进”而不是最优。

检查求解器返回的解中 Trans[i, j]/limit[i, j] 的值，可以为困难提供线索：

ampl: display {i in ORIG, j in DEST} Trans[i, j]/limit[i, j];  
Trans[i, j]/limit[i, j] [*,*] (tr)  
: CLEV GARY PITT :=  
DET - 6.125e- 14 0 2  
FRA 0 1.5 0.1875  
FRE 0.7 1 0.5  
LAF 0.4 0.15 0.5  
LAN 0.375 7.03288e- 15 0.5  
STL 2.9 0 0.5  
WIN 0.125 0 0.5  
;

这些比率表明，对于几对运输路径（如 Trans[CLEV, STL]），其运输量显著超过了限制。更严重的是，Trans[GARY, FRE] 的比率正好为 1，这表明它恰好达到了 limit[GARY, FRE] 的限制。如果我们以完整精度显示它们，可以看到：

ampl: option display_precision 0;  
ampl: display Trans['GARY', 'FRE'], limit['GARY', 'FRE'];  
Trans['GARY', 'FRE'] = 500.0000000000028  
limit['GARY', 'FRE'] = 500

![](https://cdn-mineru.openxlab.org.cn/result/2025-09-04/c27db974-6ee8-418f-9d81-3e975c6552ef/791cd5f55e0e18743fdf7f8c7770a2a0d35a24c4b4fd510958fcdad7be66570e.jpg)  
图 18-6：成本函数 $y = \frac{x}{1 - \frac{x}{c}}$ 中的奇点。

变量值仅略微超过限制，因此成本项出现了巨大的负值。如果我们绘制整个成本函数的图像，如图 18-6 所示，可以看到成本函数在 limit[GARY, FRE] 处的奇点右侧趋向于 $-\infty$。

上述两次运行中的误差来源在于我们假设：由于当 Trans[i,j] 从下方趋近于 limit[i,j] 时，目标函数趋向于 $+\infty$，因此求解器会将 Trans[i,j] 保持在 0 和 limit[i,j] 之间。但至少对于这个求解器来说，我们必须通过为每个 Trans[i,j] 显式设置一个略小于 limit[i,j] 的上界来强制执行这一假设，但该上界必须足够接近，以不影响最终的最优解：

```
var Trans {i in ORIG, j in DEST} >= 0, <= .9999 * limit[i,j];
```

经过这一修改后，求解器能够轻松找到最优解：

```
mpl: option display_precision 6;  
ampl: model nltransb.mod; data nltrans.dat; solve;  
MINDS 5.5: optimal solution found.  
81 iterations, objective 1212117  
ampl: display Trans;  
Trans [*,*] (tr)  
: CLEV GARY PITT :=  
DET 586.372 187.385 426.242  
FRA 294.993 81.2205 523.787  
FRE 365.5 369.722 364.778  
LAF 490.537 0 509.463  
LAN 294.148 0 305.852  
STL 469.691 761.672 468.637  
WIN 98.7595 0 301.241  
;
```

这些变量值远离任何奇点，其中 Trans[i,j]/limit[i,j] 在所有情况下都小于 0.96。（如果你将初始猜测值改为 limit[i,j]/2，如前所述，你应该会发现解是相同的，但求解器只需要大约一半的迭代次数即可找到解。）

这里的直接教训是，非线性函数在变量预期范围之外可能会表现出相当糟糕的行为。图 18-2e 中的不完整图形使这个成本函数看起来误导性地“表现良好”，而图 18-6 则显示了需要设置边界以使变量远离奇点。

更一般的教训是，非线性函数所带来的困难可能导致求解器以各种方式失败。在开发非线性模型时，你需要警惕求解器给出的奇怪结果，并可能需要进行一些侦探工作，以将问题追溯到模型中的缺陷。

# 多个局部最优解

为了说明非线性优化中的另一种困难，我们考虑一个稍作修改的目标函数，其公式如下：

```
minimize Total Cost: sum {i in ORIG, j in DEST} rate[i,j] * Trans[i,j]^0.8 / (1 - Trans[i,j]/limit[i,j]);
```

通过将运输量提高到 0.8 次幂，我们使成本函数在较低运输量时呈凹形，在较高运输量时呈凸形，如图 18-2f 所示。尝试求解这个新模型时，我们再次遇到技术难题：

```
ampl: model nltransc.mod; data nltrans.dat; solve;
MINOS 5.5: Error evaluating objective Total Cost: can't evaluate pow'(0,0.8)
MINOS 5.5: solution aborted.
8 iterations, objective 0
```

这次我们自然怀疑到 `Trans[i,j]^0.8`，这是我们在模型中唯一修改的表达式。错误信息中提到的 `pow'(0,0.8)` 提供了进一步线索，它表示指数（幂）函数在零点的导数。当 `Trans[i,j]` 为零时，该函数有一个明确的值，但其关于变量的导数（即图 18-2f 中曲线的斜率）是无穷大。因此，总成本对任何变量在零点的偏导数无法返回给求解器；由于求解器的优化算法需要所有偏导数，它因此放弃求解。

这是另一种形式的范围违规问题，同样可以通过施加一些边界条件来避免解靠近问题点。在本例中，我们将下界从零调整为一个非常小的正数：

```
var Trans {i in ORIG, j in DEST} >= 1e-10, <= 0.9999 * limit[i,j], := 0;
```

我们也可以将初始猜测值从零移开，但在本例中求解器会自动处理，因为初始值只是建议起始点。

调整边界后，求解器正常运行并报告了一个解：

```
ampl: model nltransd.mod; data nltrans.dat; solve;
MINDS 5.5: optimal solution found.
65 iterations, objective 427568.1225
ampl: display Trans;
Trans [* ,* ] (tr)
CLEV    GARY    PITT
...
DET   689.091  1e-10   510.909
FRA    1e-10   199.005 700.995
FRE   385.326 326.135 388.54
LAF   885.965 114.035  1e-10
LAN   169.662  1e-10   430.338
STL   469.956 760.826 469.218
WIN    1e-10    1e-10   400 ;
```

我们可以将每个 `1e-10` 视为零，因为与解中的其他值相比，这样的小值可以忽略不计。

接下来，我们再次尝试使用 `limit[i,j]/2` 作为初始猜测值，希望加快求解速度。结果如下：

```
ampl: let {i in ORIG, j in DEST} Trans[i,j] := limit[i,j]/2;
ampl: solve;
MINDS 5.5: optimal solution found.
40 iterations, objective 355438.2006
ampl: display Trans;
Trans [* ,* ] (tr)
:     CLEV    GARY    PITT
...
DET   540.601 265.509 393.89
FRA   328.599  1e-10  571.401
FRE   364.639 371.628 363.732
LAF   491.262  1e-10  508.738
LAN   301.741  1e-10  298.259
STL   469.108 762.863 468.029
WIN   104.049  1e-10  295.951 ;
```

不仅解完全不同，而且最优值降低了 17%！第一个解并不能真正最小化在约束条件下所有可行解中的目标函数值。

实际上，这两种解都可以被认为是正确的，因为它们都是局部最优解 (local optimum)。也就是说，每个解都比其他附近的解成本更低。本章所讨论的所有经典非线性优化方法，都是为了寻找局部最优解而设计的。从一个指定的初始猜测开始，这些方法并不能保证找到全局最优解 (global optimum)，即在所有满足约束条件的解中目标函数值最好的解。通常来说，寻找全局最优解比寻找局部最优解要困难得多。

幸运的是，在许多情况下，局部最优解就已经完全令人满意了。当目标函数和约束满足某些性质时，任何局部最优解同时也是全局最优解；本节开头所考虑的模型就是一个例子，其中目标函数的凸性 (convexity) 与约束的线性 (linearity) 保证了求解器将找到一个全局最优解。（线性规划 (Linear programming) 是一个更特殊的情况，具有这种性质；这就是为什么在前面的章节中我们从未遇到过不是全局最优的局部最优解。）

即使存在多个局部最优解，对所建模问题的了解也可能帮助你识别出全局最优解。也许你可以选择一个接近全局最优解的初始解，或者可以添加一些约束来排除已知包含局部最优解的区域。

最后，即使你无法保证找到的解是全局最优的，你可能也满足于找到一个非常好的局部最优解。一种直接的方法是系统地尝试一系列不同的起始点，并从中选取最优解。作为一个简单的例子，假设我们在示例中按如下方式声明变量：

```javascript
param alpha >= 0, <= 1;
var Trans {i in ORIG, j in DEST}  >= 1e-10, <= .9999 * limit[i, j], 
    := alpha * limit[i, j];
```

对于每一个 `alpha` 值，我们都会得到一个不同的初始猜测，从而可能得到不同的解。下表列出了 `alpha` 从 0 到 1 变化时的一些目标函数值：

<table>
<tr><td>alpha</td><td>Total_Cost</td></tr>
<tr><td>0.0</td><td>427568.1</td></tr>
<tr><td>0.1</td><td>366791.2</td></tr>
<tr><td>0.2</td><td>366791.2</td></tr>
<tr><td>0.3</td><td>366791.2</td></tr>
<tr><td>0.4</td><td>366791.2</td></tr>
<tr><td>0.5</td><td>355438.2</td></tr>
<tr><td>0.6</td><td>356531.5</td></tr>
<tr><td>0.7</td><td>376043.3</td></tr>
<tr><td>0.8</td><td>367014.4</td></tr>
<tr><td>0.9</td><td>402795.3</td></tr>
<tr><td>1.0</td><td>365827.2</td></tr>
</table>

我们之前找到的 `alpha` 为 0.5 的解仍然是最佳的，但鉴于这些结果，我们现在更倾向于相信它是一个非常好的解。我们还可能观察到，尽管报告的目标函数值随着起始点的选择而变化得有些不规律（这是非线性规划问题普遍具有的特征），但第二佳的 `Total_Cost` 值是通过将 `alpha` 设为 0.6 得到的。这表明，在 0.5 附近的 `alpha` 值进行更细致的搜索可能是值得的。

一些更复杂的全局优化方法正是尝试以这种方式搜索起始点，但它们采用了一种更为复杂且系统化的程序来决定下一步尝试哪些起始点。其他方法则将全局优化视为一个组合问题，并应用受整数规划（第 20 章）启发的求解方法。全局优化方法目前仍处于相对早期的发展阶段，随着经验的积累、新想法的尝试以及可用计算能力的进一步提升，这些方法有望得到改进。

# 其他陷阱

许多其他因素也会影响非线性 求解器 的效率和成功率，包括模型的构建方式以及变量单位 （或缩放比例） 的选择。通常来说，当非线性出现在目标函数中而非约束条件中时，更容易处理。AMPL 提供的自动替换变量选项 （在本章前面已描述） 在这方面可能会有所帮助。另一个经验法则是，变量的取值不应相差超过几个数量级；当某些变量以百万计，而另一些变量以千分之一计时，求解器可能会被误导。一些 求解器 会自动对问题进行缩放以尽量避免这种情况，但通过明智地选择变量表达的单位，你可以大大帮助它们。

除了我们已经讨论过的失败模式外，非线性 求解器 还有许多其他失败模式。一些非线性优化方法可能会卡在某种“驻点”（stationary point） 上，而这些驻点在任何意义上都不是最优的；可能会在需要最小值时误将极大值识别为最优解 （反之亦然）；也可能错误地表明约束条件无可行解。在这些情况下，你唯一能做的可能是尝试不同的起始猜测值；有时指定一个满足许多非线性约束条件的可行起始点会有所帮助。你也可以通过为变量设置合理的 上界 和 下界 来提高 求解器 成功的可能性。例如，如果你知道某些变量的最优值为 80 是合理的，而 800 则不合理，那么你可以为它们设定 400 的 上界 。（一旦得到一个指示的最优解，你应该检查这些“安全”边界是否被任何变量达到；如果达到，则应放宽边界并重新求解问题。）

本节的目的是说明在处理非线性模型时需要格外谨慎。如果你遇到无法通过本文所述简单方法解决的困难，你可能需要查阅 非线性规划 方面的教科书、你所使用的特定 求解器 的文档，或咨询一位熟悉非线性优化技术的数值分析师。

# 参考文献

Roger Fletcher, Practical Methods of Optimization. John Wiley & Sons (New York, NY, 1987). 理论和方法的简明综述。

Philip E. Gill, Walter Murray and Margaret H. Wright, Practical Optimization. Academic Press (New York, NY, 1981). 理论、算法和实用建议。

Jorge Nocedal and Stephen J. Wright, Numerical Optimization. Springer Verlag (Heidelberg, 1999). 关于光滑函数优化方法的教材。

Richard P. O'Neill, Mark Williard, Bert Wilkins and Ralph Pike, "A Mathematical Programming Model for Allocation of Natural Gas." Operations Research 27, 5 (1979) pp. 857- 873. 第 18.1 节中描述的天然气管道网络非线性关系的来源。

# 练习

18- 1. 在第 18.4 节的最后一个例子中，尝试更多的起始点，看看是否能找到一个更好的局部最优解。你能找到的最佳解是什么？

18- 2. 下面的小模型 fence.mod 用于确定用给定长度的围栏所能围成的最大面积矩形场地的尺寸：

param fence $>0$ var Xfield $>= 0$ var Yfield $>= 0$ maximize Area: Xfield * Yfield; subject to Enclose: 2*Xfield $+$ 2*Yfield $<=$ fence;

众所周知, 最优场地是一个正方形。

(a) 当我们尝试用 40 米长的围栏解决这个问题时, 使用变量的默认初始猜测值零, 得到了以下结果:

```python
ampl: solve;
MINOS 5.5: optimal solution found.
0 iterations, objective 0
ampl: display Xfield, Yfield;
Xfield = 0
Yfield = 0
```

什么可以解释这个意外的结果？在任何可用的非线性求解器上尝试同样的问题, 并报告你观察到的行为。

(b) 如有必要, 使用不同的起始点运行你的求解器, 确认 40 米围栏的最优尺寸确实是 $10 \times 10$。

(c) 通过一个类似的模型进行实验, 用于确定用给定面积的纸张所能包装的最大体积盒子的尺寸。

(d) 解决与 (c) 中相同的问题, 但包装的是圆柱体而不是盒子。

18-3. 在一个无名行星上, 一个下落物体在 (主要是) 每秒间隔 $t_j$ 被观察到具有大约以下高度 $h_j$:

<table>
<tr><td>tj</td><td>0.0</td><td>0.5</td><td>1.5</td><td>2.5</td><td>3.5</td><td>4.5</td><td>5.5</td><td>6.5</td><td>7.5</td><td>8.5</td><td>9.5</td><td>10.0</td></tr>
<tr><td>hj</td><td>100</td><td>95</td><td>87</td><td>76</td><td>66</td><td>56</td><td>47</td><td>38</td><td>26</td><td>15</td><td>6</td><td>0</td></tr>
</table>

根据该行星上的物理定律, 物体在任意 时间 的高度应由以下公式给出:

$$
h_j = a_0 - a_1t_j - \frac{1}{2}a_2t_j^2,
$$

其中 $a_0$ 是初始高度, $a_1$ 是初始速度, $a_2$ 是重力加速度。但由于观测并非完全精确, 因此不存在 $a_0$、$a_1$ 和 $a_2$ 的取值能使所有数据完全符合该公式。相反, 我们希望估计这三个值, 通过选择它们来最小化"平方和":

$$
\sum_{j = 1}^{n}[h_{j} - (a_{0} - a_{1}t_{j} - \frac{1}{2}a_{2}t_{j}^{2})]^{2}.
$$

其中 $t_j$ 和 $h_j$ 是表格中第 $j$ 项的观测值, $n$ 是观测数量。该表达式衡量了理想公式与观测行为之间的误差。

(a) 创建一个 AMPL 模型, 用于最小化任意观测数量 $n$ 的 $t_j$ 和 $h_j$ 的平方和。该模型应包含三个 变量 和一个目标函数, 但无 约束。

(b) 使用 AMPL 数据语句表示上述样本观测值, 并求解由此产生的非线性规划问题, 以确定 $a_0$、$a_1$ 和 $a_2$ 的估计值。

18-4. 本题涉及一个非常简单的"交通流量"网络:

![](https://cdn-mineru.openxlab.org.cn/result/2025-09-04/c27db974-6ee8-418f-9d81-3e975c6552ef/6a33bd49a4ba4f447a8b598afcf23c1fab82984fedc5614604af28dd31226010.jpg)

交通按箭头方向流动, 从交叉点 $a$ 进入, 从 $d$ 离开, 并经过 $b$ 或 $c$ 或两者。以下数据值给出了连接各交叉点的道路信息:

<table><tr><td>从</td><td>到</td><td>时间</td><td>容量</td><td>敏感性</td></tr><tr><td>a</td><td>b</td><td>5.0</td><td>10</td><td>0.1</td></tr><tr><td>a</td><td>c</td><td>1.0</td><td>30</td><td>0.9</td></tr><tr><td>c</td><td>b</td><td>2.0</td><td>10</td><td>0.9</td></tr><tr><td>b</td><td>d</td><td>1.0</td><td>30</td><td>0.9</td></tr><tr><td>c</td><td>d</td><td>5.0</td><td>10</td><td>0.1</td></tr></table>

具体而言，我们假设时间单位为分钟，容量单位为每分钟车辆数，敏感性单位为每（每分钟车辆数）的分钟数。

以下 AMPL 语句可用于表示此类网络：

set inters; # 道路交叉点  
param EN symbolic in inters; # 网络入口  
param EX symbolic in inters; # 网络出口  
set roads within {i in inters, j in inters: i <> EX and j <> EN};  
param time {roads} > 0;  
param cap {roads} > 0;  
param sens {roads} > 0;

(a) 从该网络入口到出口的最短路径是多少分钟？构建一个最短路径模型，参照 图 15-7 的方式，验证你的答案。

(b) 从入口到出口，网络能够维持的最大交通流量是多少 (单位: 辆/分钟)？构建一个类似于 图 15-6 的最大流模型来验证你的答案。

(c) 问题 (a) 仅关注交通速度，而问题 (b) 只考虑交通流量。实际上，这两个量是相互关联的。随着道路上交通流量从零开始增加，通过该道路所需的时间也会增加。

当车辆很少时，行驶时间只会适度增加，但当交通流量接近道路 容量 (cap) 时，行驶时间会迅速增加。因此，需要用一个非线性函数来建模这一现象。我们通过以下 约束 (constraints) 来定义道路 $(i, j)$ 上的行驶 时间 (T)：

```
var X {roads} >= 0; # 进入道路 (i,j) 的车辆数 (单位: 辆/分钟)
var T {roads}; # 道路 (i,j) 的行驶时间
subject to travel Time {(i,j) in roads}
    T[i,j] = time[i,j] + (sens[i,j] * x[i,j]) / (1 - x[i,j]/cap[i,j]);
```

你可以确认，当道路使用较少时，$(i,j)$ 上的行驶时间接近 `time[i,j]`，但当使用量接近 `cap[i,j]` 辆/分钟时，行驶时间趋于无穷大。参数 `sens[i,j]` 的大小控制着随着更多车辆试图进入道路时，行驶时间增加的速率。

假设我们想分析网络如何最优地处理每分钟一定数量的车辆。目标是最小化从入口到出口的平均行驶时间：

```
param through > 0; # 使用网络的车辆数 (单位: 辆/分钟)
minimize Avg_Time: 
    (sum {(i,j) in roads} T[i,j] * x[i,j]) / through;
```

非线性表达式 $\mathrm{T}[i, j] \cdot \mathrm{X}[i, j]$ 表示道路 $(i,j)$ 上的行驶分钟数乘以进入该道路的车辆数（单位：辆/分钟）——即道路 $(i,j)$ 上的车辆总数。因此，目标函数中的求和给出了整个系统中的车辆总数。将该总和除以通过网络的车辆数（单位：辆/分钟），即可得到每辆车的平均行驶分钟数。

通过添加以下内容完成模型：

- 一个 约束 (constraint)，在除入口 (EN) 和出口 (EX) 之外的每个交叉口，进入的车辆总数（单位：辆/分钟）等于离开的车辆总数。
- 一个 约束 (constraint)，离开入口 (EN) 的车辆总数（单位：辆/分钟）等于使用网络的总流量（由 `through` 表示）。
- 对 变量 (variables) 设置适当的边界。（第 18.4 节中的示例应能提示需要哪些边界。）

使用 AMPL 证明，对于上述示例，当吞吐量为 4.0 辆/分钟时，最优策略是将一半车辆沿路径 $a \rightarrow b \rightarrow d$ 发送，另一半沿路径 $a \rightarrow c \rightarrow d$ 发送，此时平均行驶时间约为 8.18 分钟。

(d) 通过尝试大于和小于 4.0 的 `through` 参数值，绘制最小平均行驶时间随吞吐量变化的函数图像。同时，记录不同吞吐量下的最优解中使用了哪些行驶路线，并在你的图像上总结这些信息。

你的图中的信息与 (a) 和 (b) 部分的解之间有什么关系？

(e) (c) 中的模型假设你可以让汽车司机走特定的路线。例如，在吞吐量为 4.0 的最优解中，不允许司机从 $c$ “抄近路”到 $b$。

如果所有司机都可以自由选择他们喜欢的路线，会发生什么？观察表明，在这种情况下，交通往往会达到一种稳定解，其中任何路线的行驶时间都不小于平均值。吞吐量为 4.0 的最优解并不稳定，因为——正如你可以验证的——路线 $a \rightarrow c \rightarrow b \rightarrow d$ 上的行驶时间仅为约 7.86 分钟；如果有许可，一些司机会尝试抄近路。

为了使用 AMPL 找到一个稳定解，我们必须添加一些数据来指定从入口 (EN) 到出口 (EX) 的可能路线：

```
param choices integer > 0; # 路线数量
set route {1..choices} within roads;
```

这里 route 是一个索引集合的集合；对于每个 r 在 1..choices 中，表达式 route[r] 表示一个不同的道路子集，这些道路共同组成一条从 EN 到 EX 的路线。对于我们的网络，choices 应该是 3，路线集合应该是 $\{(a,b),(b,d)\}$、$\{(a,c),(c,d)\}$ 和 $\{(a,c),(c,b),(b,d)\}$。使用这些数据值，可以通过一组额外的约束条件来确保稳定性条件，这些约束条件表明任何路线的行驶时间不少于所有路线的平均行驶时间：

```
subject to Stability {r in 1..choices}:
    sum {(i,j) in route[r]} T[i,j] >= (sum {(i,j) in roads} T[i,j] * x[i,j]) / through;
```

证明在吞吐量为 4.0 的稳定解中，略多于 $5\%$ 的司机会抄近路，平均行驶时间增加到约 8.27 分钟。因此，如果从未修建从 $c$ 到 $b$ 的道路，交通会更快！（这种现象被称为 Braess 悖论，以一位交通分析师命名，他注意到当在慕尼黑的道路系统中添加某个链接后，交通似乎变得更糟。）

(f) 通过尝试吞吐量值大于和小于 4.0 的情况，绘制稳定行驶时间作为吞吐量函数的图。在图上标出哪些吞吐量下的稳定时间大于最优时间。

(g) 现在假设你被雇用来分析从 $a$ 直接到 $d$ 开设一条额外的蜿蜒道路的可能性，行驶时间为 5 分钟，容量为 10，敏感度为 1.5。使用上面开发的模型，写一份关于进行此更改后果的分析报告，作为吞吐量值的函数。

18-5. 回到上一练习 (e) 中构建的模型。本练习要求通过替换一些变量来减少变量数量，如第 18.2 节所述。

(a) 将选项 show_stats 设置为 1，并求解问题。从你得到的额外输出中，验证有 10 个变量。

接下来，重复执行该会话，并将选项 `substout` 设置为 1。通过查看输出信息，验证某些变量是否通过代入被消去。这些变量必须是哪些变量？

(b) 除了设置 `substout` 外，你还可以通过在变量声明中添加合适的 = 表达式，来指定某个变量应被代入消去。修改问题 (a) 中的模型以使用此功能，并验证结果是否相同。

(c) 本模型中有一个表示平均旅行时间的长表达式出现了两次。定义一个新的变量 `Avg` 来表示该表达式。验证在求解所得模型时，AMPL 也会代入消去该变量，并且结果与之前相同。

18-6. 在《使用 GINO 进行建模与优化》一书中，Judith Liebman、Leon Lasdon、Linus Schrage 和 Allan Waren 描述了设计用于储存氨气的钢制储罐时遇到的如下问题。决策变量为：

$T$ 储罐内部温度  
$I$ 保温层厚度  

储罐内部压力是温度的函数：

$$
P = e^{-3950 / (T + 460) + 11.86}
$$

目标是最小化储罐的成本，成本由三部分组成：保温成本（取决于厚度）；钢制容器成本（取决于压力）；以及用于冷却氨气的再冷凝过程成本（取决于温度和保温层厚度）。结合工程和经济方面的考虑，得出以下公式：

$$
\begin{array}{l}
C_I = 400I^{0.9} \\
C_V = 1000 + 22(P - 14.7)^{1.2} \\
C_R = 144(80 - T) / I
\end{array}
$$

(a) 在 AMPL 中将该问题表述为一个两变量问题，以及一个六变量问题（其中四个变量可以被代入消去）。你更倾向于使用哪种表述方式？

(b) 使用你偏好的表述方式，确定最低成本储罐的参数。

(c) 增大 $C_R$ 中的因子 144 会导致再冷凝成本成比例增加。尝试几个更大的值，并大致描述随着该因子增大，总成本如何随之增加。

18-7. 社会核算矩阵（social accounting matrix）是一张表格，用于显示经济中每个部门流向其他各部门的资金流。下面是一个简单的五部门示例，空白项表示已知为零的资金流：

<table>
<tr><td></td><td>LAB</td><td>H1</td><td>H2</td><td>P1</td><td>P2</td><td>总计</td></tr>
<tr><td>LAB</td><td>15</td><td>3</td><td>130</td><td>80</td><td>220</td><td></td></tr>
<tr><td>H1</td><td>?</td><td></td><td></td><td></td><td>?</td><td></td></tr>
<tr><td>H2</td><td>?</td><td></td><td></td><td></td><td>?</td><td></td></tr>
<tr><td>P1</td><td>15</td><td>130</td><td></td><td>20</td><td>190</td><td></td></tr>
<tr><td>P2</td><td>25</td><td>40</td><td>55</td><td></td><td>105</td><td></td></tr>
</table>

如果矩阵被完美估计，它将是平衡的：每一行的和（从一个部门流出的流量）将等于相应列的和（流入的流量）。然而，实际上存在几个困难：

- 一些条目（如上所述标记为 ?）没有可靠的估计值。

- 在估计的表中，行和不一定等于列和。

- 我们对每个部门的总流入（或流出）流量有单独的估计值，如表中行右侧所示。这些估计值不一定等于估计行或列的和。

可以使用非线性规划来调整该矩阵，通过找到在某种意义上最接近给定矩阵的平衡矩阵。

对于一组部门 $S$，令 $E_{T} \subseteq S$ 表示我们有估计总流量的部门子集，令 $E_{A} \subseteq S \times S$ 包含所有有已知估计值的部门对 $(i, j)$。给定的数据值为：

$t_i$ 估计的行/列和，$i \in E_T$  
$a_{ij}$ 估计的社会核算矩阵条目，$(i, j) \in E_A$

令 $S_A \subseteq S \times S$ 包含所有应在矩阵中有条目的行-列对 $(i, j)$ —— 这包括包含 ? 而不是数字的条目。我们希望确定调整后的条目 $A_{ij}$，对于每个 $(i, j) \in S_A$，这些条目是真正平衡的：

$$
\begin{array}{r}
\sum_{j\in S:(i,j)\in S_A}A_{ij} = \sum_{j\in S:(j,i)\in S_A}A_{ji}
\end{array}
$$

对所有 $i \in S$ 成立。你可以将这些方程视为变量 $A_{ij}$ 的约束。

没有最佳函数来衡量“接近”，但一个流行的选择是估计值与调整值之间差异的平方和 —— 对于矩阵和行与列的和 —— 并以估计值为尺度。为了方便，我们将调整后的和写成定义变量：

$$
T_{i} = \sum_{j\in S:(i,j)\in S_{A}}A_{ij}
$$

然后目标是最小化

$$
\begin{array}{r}
\sum_{(i,j)\in E_A}(a_{ij} - A_{ij})^2 /a_{ij} + \sum_{i\in E_T}(t_i - T_i)^2 /t_i
\end{array}
$$

为此问题建立一个 AMPL 模型，并确定一个最优的调整矩阵。

18-8. 一个管道网络的布局如下：

![](https://cdn-mineru.openxlab.org.cn/result/2025-09-04/c27db974-6ee8-418f-9d81-3e975c6552ef/2704b0ee1d720ab432723b799488a2aa686677b15c6944852f80dd1f0528be55.jpg)

圆圈代表接头，箭头代表管道。接头 1 和 2 是流量的来源，接头 9 是流量的汇点或目的地，但管道中的流量可以是任一方向。与每个接头 $i$ 相关联的是在该接头处提取的流量 $w_i$ 和海拔高度 $e_i$：

<table>
<tr><td></td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td></tr>
<tr><td>$w_i$</td><td>0</td><td>0</td><td>200</td><td>0</td><td>0</td><td>200</td><td>150</td><td>0</td><td>0</td><td>150</td></tr>
<tr><td>$e_i$</td><td>50</td><td>40</td><td>20</td><td>20</td><td>0</td><td>0</td><td>0</td><td>20</td><td>20</td><td>20</td></tr>
</table>

我们的 决策 变量 (decision variables) 是从 $i$ 到 $j$ 的管道中的流量 $F_{ij}$，正值表示沿箭头方向的流动，负值表示相反方向的流动。自然地，在每个节点处流入的流量必须等于流出的流量加上在该节点提取的量，除了源点和汇点。

管道的 "水头损失" (head loss) 是推动流体通过管道所需能量的一种度量。在我们的情况下，从 $i$ 到 $j$ 的管道水头损失与流量的平方成正比：

$$
H_{ij} = Kc_{ij}F_{ij}^{2}\mathrm{~if~}F_{ij} > 0,
$$

$$
H_{ij} = -Kc_{ij}F_{ij}^2\mathrm{~if~}F_{ij}< 0,
$$

其中 $K = 4.96407\times 10^{- 6}$ 是一个转换常数，$c_{ij}$ 是根据管道的直径、摩擦系数和长度计算出的一个因子：

<table><tr><td>from</td><td>to</td><td>cij</td></tr><tr><td>1</td><td>3</td><td>6.36685</td></tr><tr><td>2</td><td>4</td><td>28.8937</td></tr><tr><td>3</td><td>10</td><td>28.8937</td></tr><tr><td>3</td><td>5</td><td>6.36685</td></tr><tr><td>3</td><td>8</td><td>43.3406</td></tr><tr><td>4</td><td>10</td><td>28.8937</td></tr><tr><td>4</td><td>6</td><td>28.8937</td></tr><tr><td>5</td><td>6</td><td>57.7874</td></tr><tr><td>5</td><td>7</td><td>43.3406</td></tr><tr><td>6</td><td>7</td><td>28.8937</td></tr><tr><td>8</td><td>4</td><td>28.8937</td></tr><tr><td>8</td><td>9</td><td>705.251</td></tr></table>

对于处于相同高程的两个节点 $i$ 和 $j$，从 $i$ 到 $j$ 流动时的压力降等于水头损失。压力和水头损失都以英尺为单位测量，因此在对节点之间的高程差进行修正后，我们有如下关系：

$$
H_{ij} = (P_i + e_i) - (P_j + e_j)
$$

最后，我们希望保持源点和汇点的压力均为 200 英尺。

(a) 为这种情况建立一个通用的 AMPL 模型，并整理上述数据的 数据 语句 (data statements)。

(b) 这里没有目标函数，但你仍然可以使用一个非线性 求解器 (solver) 来寻找一个可行解。通过将选项 show_stats 设置为 1，确认 变量 数量等于方程数量，从而在解中没有 "自由度"。（但这并不能保证解是唯一的。）

检查你的 求解器 是否找到了方程的解，并 显示 (display) 结果。